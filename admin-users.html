<!DOCTYPE html>
<html lang="bg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление на потребители | GKS STORE</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <a href="index.html">
                <div class="logo-bg">
                    <img src="images/logo.png" alt="GKS Store Logo" class="navbar-logo">
                </div>
                <span>STORE</span>
            </a>
        </div>
        <ul class="nav-links">
            <li><a href="admin.html">Продукти</a></li>
            <li><a href="admin-users.html" class="active">Потребители</a></li>
            <li id="auth-status"></li>
        </ul>
    </nav>

    <main class="catalog">
        <div class="hero-content" style="text-align: center; margin-bottom: 50px;" data-aos="fade-down">
            <h1>УПРАВЛЕНИЕ НА <span>ПОТРЕБИТЕЛИ</span></h1>
            <p>Тук можете да преглеждате потребителите и да задавате администраторски права.</p>
        </div>

        <div id="admin-guard" style="display: none;">
            <div class="users-grid" id="users-admin-list">
                <p style="text-align: center; opacity: 0.5;">Зареждане на потребители...</p>
            </div>
        </div>

        <div id="no-access" style="display: none; text-align: center; margin-top: 100px;">
            <h2>Достъпът е отказан! ❌</h2>
            <p>Нямате нужните права за тази страница.</p>
            <a href="index.html" class="btn-buy" style="display: inline-block; margin-top: 20px;">Към началото</a>
        </div>
    </main>

    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="script.js"></script>
    <script type="module">
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const auth = getAuth();
        const db = getFirestore();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    document.getElementById('admin-guard').style.display = 'block';
                    loadUsers();
                } else {
                    document.getElementById('no-access').style.display = 'block';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadUsers() {
            const container = document.getElementById('users-admin-list');
            const snapshot = await getDocs(collection(db, "users"));
            container.innerHTML = "";

            snapshot.forEach(userDoc => {
                const u = userDoc.data();
                const card = document.createElement('div');
                card.className = 'user-admin-card';
                card.innerHTML = `
                    <div class="user-info">
                        <p class="user-email">${u.email}</p>
                        <p class="user-role">Роля: <span class="${u.role}">${u.role}</span></p>
                    </div>
                    <div class="user-actions">
                        ${u.role !== 'admin' ?
                        `<button class="btn-make-admin" onclick="changeRole('${userDoc.id}', 'admin')">Направи Админ</button>` :
                        `<button class="btn-make-user" onclick="changeRole('${userDoc.id}', 'user')">Премахни Админ</button>`
                    }
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.changeRole = async (uid, newRole) => {
            if (confirm(`Сигурни ли сте, че искате да смените ролята на ${newRole}?`)) {
                await updateDoc(doc(db, "users", uid), { role: newRole });
                location.reload();
            }
        }
    </script>
</body>

</html>